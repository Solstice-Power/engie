---
title: "Microsoft Engie"
output: 
  rmdformats::downcute:
    toc_depth: 3
---


# Overview


```{r setup, include=FALSE}

source('helper_functions.R')
load_packages()



```




## Utility Zones

There are two main utility zones in Illinois Solstice works with: Ameren and ComEd. Note a third utility, MidAmerican, does have a slight bit of coverage into Mercer and Henry Counties where Ameren and ComEd coverage ends. 



```{r message=FALSE, warning=FALSE, include=FALSE}


hifld_df <- st_read("utility_zones/HIFLD/Electric_Retail_Service_Territories (1)/Electric_Retail_Service_Territories.shp") 

state_list <- c("IL", "MA", "MN", "NJ", "NM", "NY",  "CA", "DE")


temp_util <- hifld_df %>%
  filter(ID %in% c(56697, 4110,12341)) %>%
  mutate(new_name = case_when(
    ID == 56697 ~ "Ameren",
    ID == 4110 ~ "ComEd",
    ID == 12341 ~ "MidAmerican"
  ))

get_tracts <- get_acs(
  geography="tract", 
  state="IL",
  variables=c("total_pop" = "B01001_001"),
  year=2019, 
  geometry=TRUE) %>%
  mutate(total_pop = estimate) %>%
  select(geoid=GEOID, geometry, total_pop) 


new_tracts <- get_acs(
  geography="tract", 
  state="IL",
  variables=c("total_pop" = "B01001_001"),
  year=2020, 
  geometry=TRUE) %>%
  mutate(total_pop = estimate) %>%
  select(geoid=GEOID, geometry, total_pop) 


```



```{r message=FALSE, warning=FALSE, include=FALSE}
chas_df <- load_chas() %>%
    mutate(State_Name = case_when(
    state == 17 ~ "Illinois",
    state == 25 ~ "Massachusetts",  
    state == 27 ~ "Minnesota",  
    state == 34 ~ "New Jersey",
    state == 35 ~ "New Mexico",  
    state == 36 ~ "New York",
    state == 06 ~ "California",
    TRUE ~ "Other"
  ))

il_counties <- get_acs(geography="county",
                       variables = c("Total_Pop" = "B01001_001","snap_hh" = "B22001_002","snap_pop" = "B19058_002"), 
              state = "IL", 
              year = 2021,
              geometry = TRUE) %>%
  group_by(NAME, GEOID) %>%
  summarise(total_pop = estimate[variable=="Total_Pop"],
            snap_hh = estimate[variable=="snap_hh"],
            snap_pop = estimate[variable=="snap_pop"])



il_tracts <- get_acs(
  geography="tract", 
  state="IL",
  variables=c("snap_hh" = "B22001_002",
              "snap_pop" = "B19058_002",
              "medicaid_1" = "C27007_004",
              "medicaid_2" = "C27007_007",
              "medicaid_3" = "C27007_010",
              "medicaid_4" = "C27007_014",
              "medicaid_5" = "C27007_017",
              "medicaid_6" = "C27007_020",
              "Total_Pop" = "B01001_001"
              
              ),
  year=2021, 
  geometry=TRUE) %>%
  group_by(GEOID) %>%
  summarise(snap_hh = estimate[variable=="snap_hh"],
            snap_pop = estimate[variable=="snap_pop"],
            medicaid_pop =estimate[variable=="medicaid_1"] + 
                          estimate[variable=="medicaid_2"] +
                          estimate[variable=="medicaid_3"] +
                          estimate[variable=="medicaid_4"] +
                          estimate[variable=="medicaid_5"] +
                          estimate[variable=="medicaid_6"] ,
            total_pop = estimate[variable=="Total_Pop"])

add_geo <- merge(chas_df, get_tracts) 

add_geo <- st_as_sf(add_geo)

il_geo <- add_geo %>%
  filter(State_Name=="Illinois")

temp_util <- st_transform(temp_util, st_crs(il_geo)) %>%
  st_make_valid()
```



```{r echo=FALSE, message=FALSE, warning=FALSE}

pal5 <- colorFactor(
  palette="viridis",
  domain=temp_util$new_name
)

# Unhide for Mercer and Henry County MidAmerican Utility deep dive
# il_counties <- il_counties %>%
#   filter(GEOID == 17073 | GEOID == 17131)

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp_util,
              group="Utility Zones",
              stroke=TRUE,
              color=~pal5(temp_util$new_name),
              dashArray="3",
              fillOpacity=0.25,
              popup=paste("Utility Zone: ", temp_util$new_name)) %>%
  addLegend(position="bottomright",
            pal=pal5,
            values=temp_util$new_name,
            title="Solstice IL Utilities") %>%
  addPolygons(data=il_counties, 
              stroke=TRUE,
              color="black",
              dashArray="3",
              group="Counties",
              fillOpacity=0,
              popup=paste("Utility Zone: ", il_counties$NAME)) %>%
  # addPolygons(data = il_tracts,
  #             color = "red",
  #             fillOpacity = .5,
  #             popup=paste("GEOID: ", il_tracts$geoid)) %>%
  
  
  addLayersControl(
    overlayGroups=c( "Counties", "Utility Zones"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  )
```



The below table shows the total sums of the demographics and LMI populations by utility zone coverage. ComEd covers about three times as much population as Ameren in Illinois. 



```{r echo=FALSE, message=FALSE, warning=FALSE}
## Mercer Demographic Table



temp <- il_tracts %>% 
  st_point_on_surface() %>%
  st_make_valid() %>%
  st_join(temp_util %>% select(NAME)) %>%
  st_drop_geometry() %>%
  group_by(Name = NAME) %>%
  filter(!is.na(Name)) %>%
  summarise(`Total Pop` = sum(total_pop),
            `SNAP` = sum(snap_pop),
            `Medicaid` = sum(medicaid_pop)) %>%
  adorn_totals("row") 



temp_get_ami <- il_geo %>%
  st_point_on_surface() %>%
  st_make_valid() %>%
  st_join(temp_util %>% select(NAME)) %>%
  st_drop_geometry() %>%
  group_by(Name = NAME) %>%
  filter(!is.na(Name)) %>%
  summarise(`100% AMI` = sum(AMI_100),
            `80% AMI` = sum(AMI_80)) %>%
  adorn_totals("row") %>%
  select(-Name) 


  
temp_total <- cbind(temp, temp_get_ami)

datatable(temp_total, caption = "Total Illinois Demographics by Utility Coverage, Sources: ACS 2021 and HUD CHAS")%>%
  formatCurrency('Total Pop', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatCurrency('SNAP', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatCurrency('Medicaid', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatCurrency('100% AMI', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatCurrency('80% AMI', currency = "", mark = ",", interval = 3, digits = 0) 




```





# Geoqualification

The Microsoft Engie project uses a geoqualification map that was designed by Solstice. More details on the data used to create this map can be found Geospatial Methodology tab. 




```{r message=FALSE, warning=FALSE, include=FALSE}
engie_tracts <- st_read("/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/Shared drives/Product | Jake/Geocoding/Engie:Microsoft Geodata/MFST Engie Qualified Tracts.shp") 

# Population Var: TotalPp

engie_tracts <- st_transform(engie_tracts, st_crs(get_tracts))

old_sfa <- st_read("/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/Shared drives/Product | Jake/Geocoding/ILSFA/Qualified Tracts/ILSFA Qualified Tracts.shp")

old_sfa <- st_transform(old_sfa, st_crs(get_tracts))


new_sfa <- st_read("/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/Shared drives/Product | Jake/Geocoding/ILSFA/Updated Map June 2023/Tract_ILSFA_IncomeEligible_POLY_Map-Data/Tract_ILSFA_IncomeEligible_POLY.shp") %>%
  filter(IncomeElig==1)

new_sfa <- st_transform(new_sfa, st_crs(get_tracts))


combined_sfa <- st_read("/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/Shared drives/Product | Jake/Geocoding/ILSFA/Updated Map June 2023/combined_ilsfa_maps.geojson")

combined_sfa <- st_transform(combined_sfa, st_crs(get_tracts))


get_tracts <- get_tracts %>%
  mutate(
    engie = (geoid %in% engie_tracts$GEOID),
    old_sfa = (geoid %in% old_sfa$GEOID)
  )

new_tracts <- new_tracts %>%
  mutate(

    new_sfa = (geoid %in% new_sfa$GEOID)
    
  )

```





```{r echo=FALSE, message=FALSE, warning=FALSE}
leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=engie_tracts,
              group="Engie",
             # stroke=TRUE,
              color="lightgreen",
              dashArray="3",
              fillOpacity=0.55,
              popup=paste("GEOID: ", engie_tracts$GEOID))

```

Note in the below table, you'll see the Engie map covers nearly 62% of the state's population. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

# get 2020 population covered by combined layer

temp_centroids <- combined_sfa %>%
  st_point_on_surface() %>%
  st_join(new_tracts %>% select(geoid, total_pop)) %>%
  st_drop_geometry() %>%
  group_by(geoid) %>%
  filter(!is.na(geoid)) %>%
  summarise(total_pop = max(total_pop))


temp <- data.frame(Method = c("Engie"),
                   Population = c(sum(get_tracts$total_pop[get_tracts$engie==1]))
                   )

temp$`Percentage` <- temp$Population/sum(new_tracts$total_pop)




datatable(temp, caption = "Illinois Geoqualification Method Totals")%>%
  formatCurrency('Population', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatPercentage('Percentage', digits = 2)



```



# LMI Qualification

For the Engie program, we use percentage of households earning up to 80% and 100% AMI, number of households receiving SNAP and Medicaid to estimate LMI populations. 


```{r message=FALSE, warning=FALSE, include=FALSE}
il_tracts <- get_acs(
  geography="tract", 
  state="IL",
  variables=c("Total_Pop" = "B01001_001","snap_hh" = "B22001_002","snap_pop" = "B19058_002"
              
              ),
  year=2019, 
  geometry=TRUE) %>%
  group_by(GEOID) %>%
  summarise(total_pop = estimate[variable=="Total_Pop"],
            snap_hh = estimate[variable=="snap_hh"],
            snap_pop = estimate[variable=="snap_pop"])







total_il_tracts <- cbind(il_geo, il_tracts)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}


snap_pal <- colorNumeric(
  palette=c("Oranges"),
  domain=total_il_tracts$snap_hh
)

ami_pal <- colorNumeric(
  palette=c("Purples"),
  domain=total_il_tracts$AMI_80_Pct
)


leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  
  # Utility Zones
    addPolygons(data=temp_util,
              group="Utility Zones",
              stroke=TRUE,
              color="black",
              dashArray="3",
              fillOpacity=0,
              popup=paste("Utility Zone: ", temp_util$new_name)) %>%


  # SNAP
  
  addPolygons(data=total_il_tracts,
              group="SNAP",
             # stroke = TRUE,
              color = ~snap_pal(total_il_tracts$snap_hh),
              fillOpacity=0.75,
              popup=paste("Census Block Group: ", total_il_tracts$geoid, "<br>",
                          "SNAP HHs: ", total_il_tracts$snap_hh)) %>%
  addLegend(position="topleft",
            pal=snap_pal,
            group="SNAP",
            values=total_il_tracts$snap_hh,
            title="SNAP HHs")  %>%
  
  # AMI
  addPolygons(data=total_il_tracts,
              group="80% AMI",
             # stroke = TRUE,
              color = ~ami_pal(total_il_tracts$AMI_80_Pct),
              fillOpacity=0.75,
              popup=paste("Census Block Group: ", total_il_tracts$geoid, "<br>",
                          "80% AMI: ", total_il_tracts$AMI_80_Pct)) %>%
  addLegend(position="bottomleft",
            pal=ami_pal,
            group="80% AMI",
            values=total_il_tracts$AMI_80_Pct,
            title="80% AMI")  %>%
  
    # 100 AMI
  addPolygons(data=total_il_tracts,
              group="100% AMI",
             # stroke = TRUE,
              color = ~ami_pal(total_il_tracts$AMI_100_Pct),
              fillOpacity=0.75,
              popup=paste("Census Block Group: ", total_il_tracts$geoid, "<br>",
                          "100% AMI: ", total_il_tracts$AMI_100_Pct)) %>%
  addLegend(position="bottomleft",
            pal=ami_pal,
            group="100% AMI",
            values=total_il_tracts$AMI_100_Pct,
            title="100% AMI")  %>%
  
      addLayersControl(
    overlayGroups=c( "SNAP", "Utility Zones", "80% AMI", "100% AMI"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  hideGroup("80% AMI")%>%
  hideGroup("100% AMI")


```



```{r echo=FALSE, message=FALSE, warning=FALSE}






temp_table <- total_il_tracts %>% 
  st_point_on_surface() %>%
  st_make_valid() %>%
  st_join(temp_util %>% select(Utility = new_name)) %>%
  st_drop_geometry() %>%
  group_by(Utility) %>%
  summarise(`80% AMI` = sum(AMI_80),
            `100% AMI` = sum(AMI_100),
            SNAP = sum(snap_hh),
            `Total Pop` = sum(total_pop))%>%
  adorn_totals("row")


datatable(temp_table, caption = "Illinois LMI Population by Utility") %>%
    formatCurrency('80% AMI',currency = "", interval = 3, digits = 0, mark = ",") %>%
    formatCurrency('100% AMI',currency = "", interval = 3, digits = 0, mark = ",") %>%
    formatCurrency('SNAP',currency = "", interval = 3, digits = 0, mark = ",") %>%
    formatCurrency('Total Pop',currency = "", interval = 3, digits = 0, mark = ",") 




```

```{r message=FALSE, warning=FALSE, include=FALSE}

# temp_table %>%
#   filter(Utility=="Total") %>%
#   write_csv("final_data/il_lmi_total.csv")

```

